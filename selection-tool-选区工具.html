<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="./canvas//tool.js"></script>
    <style>
      canvas {
        border: 1px solid #000;
        position: fixed;
        top: 0;
        left: 0;
      }
      #clickCanvas {
        z-index: 2;
      }
      #previewCanvas {
        z-index: 1;
      }
    </style>
  </head>
  <body>
    <canvas id="clickCanvas" width="800" height="600"></canvas>
    <canvas id="previewCanvas" width="800" height="600"></canvas>

    <script>
      // 点击的画布
      var clickCanvas = document.getElementById("clickCanvas");
      var clickCtx = clickCanvas.getContext("2d");
      // 实际看的画布
      var previewCanvas = document.getElementById("previewCanvas");
      var previewCtx = previewCanvas.getContext("2d");

      var pointArr = [];

      // 定义坐标
      var originX;
      var originY;

      function toDrawLine(ctx, x, y, toX, toY) {
        // 绘制新的线条
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(toX, toY);
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 2;
        ctx.stroke();
      }

      // 监听鼠标点击事件
      clickCanvas.addEventListener("click", function (event) {
        // 获取鼠标点击相对于canvas的位置
        var rect = clickCanvas.getBoundingClientRect();
        originX = event.clientX - rect.left;
        originY = event.clientY - rect.top;
        // 排除同一位置重复点击
        if (
          originX !== getLastXY(pointArr).x &&
          originY !== getLastXY(pointArr).y
        ) {
          // 点击了第一个点，就可以结束了
          if (
            checkRangeWithError(
              originX,
              originY,
              getFirstXY(pointArr).x,
              getFirstXY(pointArr).y,
              5
            )
          ) {
            toDrawLine(
              previewCtx,
              getLastXY(pointArr).x,
              getLastXY(pointArr).y,
              getFirstXY(pointArr).x,
              getFirstXY(pointArr).y
            );
            pointArr = [];
          } else {
            pointArr.push([originX, originY]);
            if (pointArr.length > 1) {
              toDrawLine(
                previewCtx,
                getLastXY(pointArr).x,
                getLastXY(pointArr).y,
                getSecondFromEndXY(pointArr).x,
                getSecondFromEndXY(pointArr).y
              );
            }

            // 绘制一个蓝色的点
            previewCtx.fillStyle = "blue";
            previewCtx.beginPath();
            previewCtx.arc(
              getLastXY(pointArr).x,
              getLastXY(pointArr).y,
              5,
              0,
              Math.PI * 2
            ); // 绘制一个半径为5的圆形点
            previewCtx.fill();
          }
        }
      });

      // 监听鼠标双击事件
      clickCanvas.addEventListener("dblclick", function (event) {
        // 获取鼠标双击相对于canvas的位置
        var rect = clickCanvas.getBoundingClientRect();
        var x = event.clientX - rect.left;
        var y = event.clientY - rect.top;
        if (pointArr.length > 2) {
          toDrawLine(
            previewCtx,
            x,
            y,
            getFirstXY(pointArr).x,
            getFirstXY(pointArr).y
          );
          pointArr = [];
        }
      });

      // 清除线条函数（可选，用于在鼠标抬起后清除线条）
      function clearLine() {
        clickCtx.clearRect(0, 0, clickCanvas.width, clickCanvas.height);
      }

      // 绘制线条函数
      function drawLine(e) {
        if (!e) e = window.event; // 兼容IE
        var mouseX = e.clientX - clickCanvas.offsetLeft;
        var mouseY = e.clientY - clickCanvas.offsetTop;

        // 清除上一次的线条
        clearLine();

        toDrawLine(
          clickCtx,
          getLastXY(pointArr).x,
          getLastXY(pointArr).y,
          mouseX,
          mouseY
        );
      }

      // 鼠标移动时更新终点并重绘线条
      clickCanvas.addEventListener("mousemove", drawLine);
    </script>
  </body>
</html>
